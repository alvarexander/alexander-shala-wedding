<div class="admin">
    <h1 class="admin__title">Invitation Manager</h1>

    <div class="admin__toolbar">
        <mat-form-field appearance="outline" class="admin__filter">
            <mat-label>Filter</mat-label>
            <input matInput placeholder="Search by code, name, status..." [formControl]="filterCtrl" />
            <button
                mat-icon-button
                matSuffix
                aria-label="Clear"
                *ngIf="filterCtrl.value"
                (click)="filterCtrl.setValue('')"
            >
                <mat-icon class="material-symbols-outlined">close</mat-icon>
            </button>
        </mat-form-field>
        <mat-slide-toggle color="primary" [checked]="editable()" (change)="editable.set($event.checked)">
            Edit mode
        </mat-slide-toggle>
        <button mat-stroked-button color="primary" (click)="load()">
            <mat-icon class="material-symbols-outlined">refresh</mat-icon>
            Refresh
        </button>
    </div>

    <div class="admin__table-card" *ngIf="!loading(); else loadingTpl">
        <div class="admin__table-scroll">
            <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
            <!-- Invite Code -->
            <ng-container matColumnDef="invite_code">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Invite Code</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable(); else roCode">
                        <mat-form-field appearance="fill" class="w-180">
                            <input matInput [(ngModel)]="row.invite_code" />
                        </mat-form-field>
                    </ng-container>
                    <ng-template #roCode>{{ row.invite_code }}</ng-template>
                </td>
            </ng-container>

            <!-- Guest Names -->
            <ng-container matColumnDef="guest_names">
                <th mat-header-cell *matHeaderCellDef>Guest Names</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable(); else roGuestNames">
                        <mat-form-field appearance="fill" class="w-300">
                            <input
                                matInput
                                #gn
                                [value]="toCsv(row.guest_names)"
                                (input)="row.guest_names = fromCsv(gn.value)"
                                placeholder="Comma-separated"
                            />
                        </mat-form-field>
                    </ng-container>
                    <ng-template #roGuestNames>{{ toCsv(row.guest_names) }}</ng-template>
                </td>
            </ng-container>

            <!-- Attending Guest Names -->
            <ng-container matColumnDef="attending_guest_names">
                <th mat-header-cell *matHeaderCellDef>Attending Guest Names</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable(); else roAttendingNames">
                        <mat-form-field appearance="fill" class="w-300">
                            <input
                                matInput
                                #agn
                                [value]="toCsv(row.attending_guest_names)"
                                (input)="row.attending_guest_names = fromCsv(agn.value)"
                                placeholder="Comma-separated"
                            />
                        </mat-form-field>
                    </ng-container>
                    <ng-template #roAttendingNames>{{ toCsv(row.attending_guest_names) }}</ng-template>
                </td>
            </ng-container>

            <!-- Status -->
            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable(); else roStatus">
                        <mat-form-field appearance="fill" class="w-220">
                            <mat-select [(ngModel)]="row.status">
                                <mat-option *ngFor="let s of statuses" [value]="s.code">{{ s.label }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </ng-container>
                    <ng-template #roStatus>{{ statusLabel(row.status) }}</ng-template>
                </td>
            </ng-container>

            <!-- Party Size -->
            <ng-container matColumnDef="party_size">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Party Size</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable(); else roParty">
                        <mat-form-field appearance="fill" class="w-120">
                            <input matInput type="number" [(ngModel)]="row.party_size" placeholder="—" />
                        </mat-form-field>
                    </ng-container>
                    <ng-template #roParty>{{ row.party_size !== null && row.party_size !== undefined ? row.party_size : '—' }}</ng-template>
                </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let row">
                    <ng-container *ngIf="editable()">
                        <button mat-raised-button color="primary" (click)="save(row)" [disabled]="savingId() === row.id">
                            <mat-icon class="material-symbols-outlined">save</mat-icon>
                            Save
                        </button>
                        <button mat-button (click)="reset()" [disabled]="savingId() === row.id">Reset</button>
                    </ng-container>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
        </div>
        <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20, 50]"></mat-paginator>
    </div>

    <ng-template #loadingTpl>
        <div class="admin__loading">Loading…</div>
    </ng-template>
</div>
