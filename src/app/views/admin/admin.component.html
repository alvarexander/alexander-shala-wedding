<div class="admin">
    <h1 class="admin__title">Invitation Manager</h1>

    <div class="admin__toolbar">
        <mat-form-field appearance="outline" subscriptSizing="dynamic" class="admin__filter">
            <mat-label>Filter</mat-label>
            <input matInput placeholder="Search by code, name, status..." [formControl]="filterCtrl" />
            @if (filterCtrl.value) {
                <button mat-icon-button matSuffix aria-label="Clear" (click)="filterCtrl.setValue('')">
                    <mat-icon class="material-symbols-outlined">close</mat-icon>
                </button>
            }
        </mat-form-field>
        <mat-slide-toggle color="primary" [checked]="editable()" (change)="editable.set($event.checked)">
            Edit mode
        </mat-slide-toggle>
        <button mat-stroked-button color="primary" (click)="load()">
            <mat-icon class="material-symbols-outlined">refresh</mat-icon>
            Refresh
        </button>
    </div>

    @if (!loading()) {
        <div class="admin__table-card">
            <div class="admin__table-scroll">
                <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
                    <!-- Invite Code -->
                    <ng-container matColumnDef="invite_code">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Invite Code</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <mat-form-field appearance="fill" subscriptSizing="dynamic" class="w-180">
                                    <input matInput [(ngModel)]="row.invite_code" />
                                </mat-form-field>
                            } @else {
                                {{ row.invite_code }}
                            }
                        </td>
                    </ng-container>

                    <!-- Guest Names -->
                    <ng-container matColumnDef="guest_names">
                        <th mat-header-cell *matHeaderCellDef>Guest Names</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <mat-form-field appearance="fill" subscriptSizing="dynamic" class="w-300">
                                    <input
                                        matInput
                                        #gn
                                        [value]="toCsv(row.guest_names)"
                                        (input)="row.guest_names = fromCsv(gn.value)"
                                        placeholder="Comma-separated"
                                    />
                                </mat-form-field>
                            } @else {
                                {{ toCsv(row.guest_names) }}
                            }
                        </td>
                    </ng-container>

                    <!-- Attending Guest Names -->
                    <ng-container matColumnDef="attending_guest_names">
                        <th mat-header-cell *matHeaderCellDef>Attending Guest Names</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <mat-form-field appearance="fill" subscriptSizing="dynamic" class="w-300">
                                    <input
                                        matInput
                                        #agn
                                        [value]="toCsv(row.attending_guest_names)"
                                        (input)="row.attending_guest_names = fromCsv(agn.value)"
                                        placeholder="Comma-separated"
                                    />
                                </mat-form-field>
                            } @else {
                                {{ toCsv(row.attending_guest_names) }}
                            }
                        </td>
                    </ng-container>

                    <!-- Status -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <mat-form-field appearance="fill" subscriptSizing="dynamic" class="w-220">
                                    <mat-select [(ngModel)]="row.status">
                                        <mat-option *ngFor="let s of statuses" [value]="s.code">{{
                                            s.label
                                        }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            } @else {
                                {{ statusLabel(row.status) }}
                            }
                        </td>
                    </ng-container>

                    <!-- Party Size -->
                    <ng-container matColumnDef="party_size">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Party Size</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <mat-form-field appearance="fill" subscriptSizing="dynamic" class="w-120">
                                    <input matInput type="number" [(ngModel)]="row.party_size" placeholder="—" />
                                </mat-form-field>
                            } @else {
                                {{ row.party_size !== null && row.party_size !== undefined ? row.party_size : '—' }}
                            }
                        </td>
                    </ng-container>

                    <!-- Actions -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef>Actions</th>
                        <td mat-cell *matCellDef="let row">
                            @if (editable()) {
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="save(row)"
                                    [disabled]="savingId() === row.id"
                                >
                                    <mat-icon class="material-symbols-outlined">save</mat-icon>
                                    Save
                                </button>
                                <button mat-button (click)="reset()" [disabled]="savingId() === row.id">Reset</button>
                            }
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
            </div>
            <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20, 50]"></mat-paginator>
        </div>
    } @else {
        <div class="admin__loading">
            <mat-spinner diameter="48"></mat-spinner>
            <div style="margin-top: 8px; opacity: 0.8">Loading…</div>
        </div>
    }
</div>
